name: Build Sherpa Onnx TTS Engine (fork)

on:
  workflow_dispatch:    # manual run only
  push:
    branches: [ master ]  # optional; remove if you want manual-only

concurrency:
  group: apk-tts-engine-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  apk_tts_engine:
    runs-on: ubuntu-latest
    name: Build TTS Engine APK

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        total: ["1"]
        index: ["0"]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Enable ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.os }}-android

      - name: Display NDK HOME
        shell: bash
        run: |
          echo "ANDROID_NDK_LATEST_HOME: ${ANDROID_NDK_LATEST_HOME}"
          ls -lh "${ANDROID_NDK_LATEST_HOME}"

      - name: Install Python dependencies
        run: python3 -m pip install --upgrade pip jinja2 iso639-lang

      - name: Detect latest build-tools
        shell: bash
        run: |
          BUILD_TOOL_VERSION=$(ls /usr/local/lib/android/sdk/build-tools/ | tail -n 1)
          echo "BUILD_TOOL_VERSION=$BUILD_TOOL_VERSION" >> $GITHUB_ENV
          echo "Last build tool version is: $BUILD_TOOL_VERSION"

      - name: Generate build script
        shell: bash
        run: |
          cd scripts/apk
          total=${{ matrix.total }}
          index=${{ matrix.index }}
          ./generate-tts-apk-script.py --total "$total" --index "$index"
          chmod +x build-apk-tts-engine.sh
          mv -v ./build-apk-tts-engine.sh ../..

      - name: Build APK for TTS engine
        shell: bash
        run: |
          export CMAKE_CXX_COMPILER_LAUNCHER=ccache
          export PATH="/usr/lib/ccache:/usr/local/opt/ccache/libexec:$PATH"
          cmake --version
          export ANDROID_NDK="$ANDROID_NDK_LATEST_HOME"
          ./build-apk-tts-engine.sh

      - name: Show built files
        run: |
          ls -lh ./apks/
          du -h -d1 .

      # ---- OPTIONAL SIGNING (guarded) ----
      - uses: r0adkll/sign-android-release@v1
        name: Sign app APK (if secrets provided)
        if: ${{ secrets.ANDROID_SIGNING_KEY != '' && secrets.ANDROID_SIGNING_KEY_ALIAS != '' && secrets.ANDROID_SIGNING_KEY_STORE_PASSWORD != '' }}
        with:
          releaseDirectory: ./apks
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_SIGNING_KEY_STORE_PASSWORD }}
        env:
          BUILD_TOOLS_VERSION: ${{ env.BUILD_TOOL_VERSION }}

      - name: Normalize APK filenames after signing
        if: ${{ secrets.ANDROID_SIGNING_KEY != '' && secrets.ANDROID_SIGNING_KEY_ALIAS != '' && secrets.ANDROID_SIGNING_KEY_STORE_PASSWORD != '' }}
        shell: bash
        run: |
          cd apks
          rm -fv signingKey.jks *.apk.idsig *-aligned.apk || true
          shopt -s nullglob
          for apk in *-signed.apk; do
            n="${apk/-signed/}"
            mv -v "$apk" "$n"
          done

      # ---- ALWAYS upload the apks we have ----
      - uses: actions/upload-artifact@v4
        with:
          name: SherpaOnnxTtsEngine
          path: ./apks/*.apk

      # ---- DISABLED: publish to huggingface (upstream only) ----
      # - name: Publish to huggingface
      #   if: ${{ secrets.HF_TOKEN != '' }}
      #   env:
      #     HF_TOKEN: ${{ secrets.HF_TOKEN }}
      #   run: |
      #     echo "Publishing disabled for forks."
